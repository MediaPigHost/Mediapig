define(["require","exports","module","helpers","microAjax"],function(t,a,s,n){var r={init:function(){this.events(),this.subscriptions(),this.calculatePrice()},startPurchase:function(){n.postJSON(siteObj.orderConfig,window.location.origin+"/post/order",function(e){if("redirect"===e.response)return window.location.href="/manage",!1;ga("send","event","overlay","signup visible");var t=document.getElementById("overlay-content"),a=document.getElementById("signup-form-wrap");a&&a.length&&a.parentNode.removeChild(a),t.parentNode.className+=" order-overlay",t.innerHTML+=e.response,n.removeClass(t.parentNode,"overlay-loading");var s=document.getElementById("service_id").getAttribute("value");stripe=new n.stripe,stripe.setServiceID(s);var r=document.getElementById("cardDetails");r.addEventListener("submit",function(e){e.preventDefault();var t=document.getElementById("submitCardDetails");if(!(t.className.indexOf("disabled")>-1)){t.className+=" disabled";var a=r.elements;"test"===siteObj.stripe_mode?(console.log("Loading stripe in test mode"),stripe.setKey("pk_test_zKac1uVceOsFFMCWOCEl90oo")):(console.log("Stripe in live mode"),stripe.setKey("pk_live_J61gKzscdY3Rxtctc7Uyi0Rb"));for(var s={},o=0,i=a.length;i>o;o++)"submit"!==a[o].type&&(s[a[o].name]=a[o].value);stripe.createToken(s,function(e,a){if(200===e){var r=a.id,o={service_id:stripe.getServiceID(),token:r,first_name:s.firstname,last_name:s.surname};n.postJSON(o,"/order/process",function(e){var a=JSON.parse(e.response);"success"===a.status?window.location.href="/manage":(t.className=t.className.replace(/(?:^|\s)disabled(?!\S)/,""),app.publish("/message/error",a.errors))})}else t.className=t.className.replace(/(?:^|\s)disabled(?!\S)/,""),app.publish("/message/error","Incorrect card details - Please check again!")},function(){document.getElementById("card-details-form-error").innerHTML="Error - Check logs for now."})}})})},startDiscount:function(){app.ajax(window.location.origin+"/page/discount",function(e){var t=document.getElementById("overlay-content");t.parentNode.className+=" discount-overlay",n.removeClass(t.parentNode,"overlay-loading"),t.innerHTML+=e;var a=document.getElementById("discount"),s=document.getElementById("discount-code");a.addEventListener("keyup",function(){s.value.length>4?a.parentNode.classList.contains("enabled")||app.publish("/discount/validate",s.value):a.parentNode.classList.contains("enabled")&&n.removeClass(a.parentNode,"enabled")}),a.addEventListener("submit",function(e){e.preventDefault(),app.publish("/discount/validate",s.value)})}),app.subscribe("/discount/post",function(){var e=document.getElementById("discount"),t={};e=e.elements;for(var a=0,s=e.length;s>a;a++)"submit"!==e[a].type&&(t[e[a].name]=e[a].value);siteObj.orderConfig.discount_code=t.code,n.postJSON(t,"/discount/verify",function(e){var t=JSON.parse(e.response);"success"===t.status?app.publish("/discount/success",t):app.publish("/discount/fail",t)})}),app.subscribe("/discount/validate",function(){var e=document.getElementById("discount"),t=document.getElementById("discount-code");e.parentNode.className+=" enabled",t.disabled=!0,app.publish("/discount/post",t.value)}),app.subscribe("/discount/success",function(e){var t=document.getElementById("discount-form");n.removeClass(t,"enabled"),t.className+=" success",setTimeout(function(){app.publish("/overlay/close",{}),siteObj.discountPercentage=e.discount_percent,r.calculatePrice(),app.publish("/discount/applied",{})},1e3)}),app.subscribe("/discount/fail",function(e){var t=document.getElementById("discount"),a=document.getElementById("discount-code");a.disabled=!1,n.removeClass(t.parentNode,"enabled"),app.publish("/message/error",e.errors)})},calculatePrice:function(){var e=document.getElementsByClassName("order-grid"),t=parseFloat(siteObj.basePrice),a=2;siteObj.orderConfig.attributes=[];for(var s=0,r=e.length;r>s;s++){var o=e[s].getElementsByClassName("selected");if("os"===o[0].getAttribute("data-name")){var i=o[0].getElementsByClassName("os-trigger")[0].getAttribute("data-id");siteObj.orderConfig.os_variant=parseInt(i)}var l=o[0].getAttribute("data-price");siteObj.orderConfig.attributes.push(parseInt(o[0].getAttribute("data-product-id"))),null!==l&&"undefined"!=typeof l&&(t+=parseFloat(l))}"undefined"!=typeof siteObj.discountPercentage&&(t=parseFloat(t-t/100*siteObj.discountPercentage)),"month"!=siteObj.term&&(t=parseFloat(t/666),a=3),n.removeClass(document.getElementById("order-button"),"disabled"),document.getElementById("order-total-value").innerHTML=parseFloat(t).toFixed(a),ga("send","event","price change","new selection")},refreshSelectionViews:function(e,t,a){var s=document.getElementsByClassName("option-"+e);if(s.length){var r=s[0].getElementsByClassName("option-trigger"),o=s[0].getElementsByClassName("option-dropdown"),i=o[0].querySelectorAll('[data-product-id="'+t+'"] a'),l=(i[0].getElementsByClassName("option-value"),i[0].parentNode.parentNode.getElementsByTagName("li"));r[0].getElementsByClassName("option-value")[0].innerHTML=a;for(var d=0;d<l.length;d++)n.removeClass(l[d].getElementsByClassName("option-link")[0],"enabled");i[0].className+=" enabled"}for(var c=document.getElementsByClassName("section-"+e),u=c[0].querySelectorAll('[data-product-id="'+t+'"]'),p=c[0].getElementsByClassName("order-grid-item"),m=c[0].getElementsByClassName("os-variations"),d=0;d<p.length;d++)n.removeClass(p[d],"selected");for(var d=0;d<m.length;d++)n.removeClass(m[d],"selected");u[0].className+=" selected"},events:function(){n.addEventListenerByClass("order-grid-item","click",function(e){var t=e.currentTarget,a=t.getAttribute("data-name"),s=t.getAttribute("data-product-id"),n=t.getAttribute("data-value");r.refreshSelectionViews(a,s,n),r.calculatePrice(),e.preventDefault()}),n.addEventListenerByClass("os-trigger","click",function(e){var t=e.currentTarget,a=t.parentNode,s=a.parentNode.parentNode.parentNode.getElementsByClassName("os-variations"),r=!1;a.className.match(/\bselected\b/)&&(n.removeClass(a,"selected"),r=!0);for(var o=0,i=s.length;i>o;o++)n.removeClass(s[o],"selected");r||(a.className+=" selected"),r=!1,e.stopPropagation(),e.preventDefault()}),n.addEventListenerByClass("os-link","click",function(e){for(var t=e.currentTarget,a=t.getAttribute("data-value"),s=t.getAttribute("data-id"),r=t.parentNode,o=r.parentNode.parentNode,i=o.getElementsByClassName("option-value"),l=o.getElementsByClassName("os-link"),d=0,c=l.length;c>d;d++)n.removeClass(l[d],"enabled");t.className+=" enabled",i[0].innerHTML=a,i[0].setAttribute("data-id",s),e.preventDefault()}),n.addEventListenerByClass("payment-trigger","click",function(e){n.addBodyClass("overlay-visible"),r.startPurchase(),ga("send","event","click","payment trigger"),e.preventDefault()}),n.addEventListenerByClass("discount-trigger","click",function(e){n.addBodyClass("overlay-visible"),r.startDiscount(),ga("send","event","click","discount trigger"),e.preventDefault()}),n.addEventListenerByClass("overlay-close","click",function(e){app.publish("/overlay/close",e)}),n.addEventListenerByClass("option-trigger","click",function(e){var t=e.currentTarget,a=t.parentNode;siblings=a.parentNode.getElementsByClassName("option"),isSelected=!1,a.className.match(/\bselected\b/)&&(n.removeClass(a,"selected"),isSelected=!0);for(var s=0,r=siblings.length;r>s;s++)n.removeClass(siblings[s],"selected");isSelected||(a.className+=" selected"),isSelected=!1,e.preventDefault()}),n.addEventListenerByClass("option-link","click",function(e){var t=e.currentTarget,a=t.parentNode,s=t.parentNode.parentNode.parentNode,o=a.getAttribute("data-name"),i=a.getAttribute("data-product-id"),l=a.getAttribute("data-value");r.refreshSelectionViews(o,i,l),r.calculatePrice(),n.removeClass(s,"selected"),e.preventDefault()}),document.getElementById("month-multi").addEventListener("click",function(e){e.preventDefault(),ga("send","order","click","monthly trigger"),siteObj.term="month";var t=document.getElementById("selected-term");t.innerHTML=this.innerHTML,n.removeClass(this.parentNode.parentNode.parentNode,"selected"),r.calculatePrice()}),document.getElementById("hour-multi").addEventListener("click",function(e){e.preventDefault(),ga("send","order","click","hourly trigger"),siteObj.term="hour";var t=document.getElementById("selected-term");t.innerHTML=this.innerHTML,n.removeClass(this.parentNode.parentNode.parentNode,"selected"),r.calculatePrice()})},subscriptions:function(){app.subscribe("/overlay/close",function(){n.removeBodyClass("overlay-visible"),document.getElementById("overlay-content").parentNode.className="overlay-wrap overlay-loading";var t=document.getElementById("card-details-form-wrap");t&&t.parentNode.removeChild(t);var a=document.getElementById("signup-form-wrap");a&&a.parentNode.removeChild(a);var s=document.getElementById("discount-form");s&&s.parentNode.removeChild(s),"undefined"!=typeof e&&e.preventDefault()}),app.subscribe("/discount/applied",function(){n.addBodyClass("discount-applied"),ga("send","order","price change","discount applied"),setTimeout(function(){n.addBodyClass("discount-applied-fadeout"),n.removeBodyClass("discount-applied")},5e3),setTimeout(function(){n.removeBodyClass("discount-applied-fadeout")},7e3)}),app.subscribe("/form/register/update",function(e){"success"===e&&(document.getElementById("overlay-content").parentNode.className+=" overlay-loading",r.startPurchase())})}};s.exports=r});